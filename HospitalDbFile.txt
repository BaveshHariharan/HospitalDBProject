DROP TABLE IF EXISTS Room;
DROP TABLE IF EXISTS prefroom;
DROP TABLE IF EXISTS Surgeon;
DROP TABLE IF EXISTS Client;
DROP TABLE IF EXISTS Customer;
DROP TABLE IF EXISTS Patient;
DROP TABLE IF EXISTS Fees;
DROP TABLE IF EXISTS Service;
DROP TABLE IF EXISTS Appointment;
DROP TABLE IF EXISTS Invoice;

CREATE TABLE IF NOT EXISTS Room (
    uniqueNumber INTEGER(3) PRIMARY KEY,
    uniqueIdentifierCode(2) TEXT,
    FOREIGN KEY (uniqueIdentifierCode) REFERENCES Surgeon(uniqueIdentifierCode)
);

CREATE TABLE IF NOT EXISTS prefroom (
    preferredRoom TEXT(5),
    uniqueIdentifierCode(2) TEXT PRIMARY KEY,
    FOREIGN KEY (uniqueIdentifierCode) REFERENCES Surgeon(uniqueIdentifierCode)
);

CREATE TABLE IF NOT EXISTS Surgeon (
    uniqueIdentifierCode TEXT(2) PRIMARY KEY,
    familyName TEXT(20),
    personalName TEXT(20),
    title TEXT(4),
    contactPhoneNumber TEXT(14),
    qualifications TEXT(10)
);

CREATE TABLE IF NOT EXISTS Client (
    clientNumber INTEGER(8) PRIMARY KEY,
    familyName TEXT(20),
    personalName TEXT(20),
    title TEXT(4),
    streetAddress TEXT(45),
    postcode TEXT(4)
);

CREATE TABLE Customer (
    customerid INTEGER(8) PRIMARY KEY,
    clientNumber INTEGER(8) NOT NULL,
    contactPhoneNumebers TEXT(14),
    FOREIGN KEY clientNumber references Client(clientNumber)
);

CREATE TABLE IF NOT EXISTS Patient (
    patientid INTEGER(8) PRIMARY KEY,
    birthdate TEXT(20),
    customerid INTEGER(8) NOT NULL,
    medicareNumber TEXT(12),
    FOREIGN KEY (customerid) REFERENCES Customer(customerid) ON UPDATE CASCADE
);

CREATE TABLE IF NOT EXISTS Fees (
    actualFee NUMERIC(5, 2),
    uniqueIdentifierCode TEXT(2) PRIMARY KEY,
    FOREIGN KEY (uniqueIdentifierCode) REFERENCES Surgeon(uniqueIdentifierCode)
);

CREATE TABLE IF NOT EXISTS Service (
    prescribedCode TEXT(4) PRIMARY KEY,
    description TEXT(20),
    currentServiceFee NUMERIC(3, 2),
    uniqueIdentifierCode TEXT(2),
    FOREIGN KEY (uniqueIdentifierCode) REFERENCES Surgeon(uniqueIdentifierCode)
);

CREATE TABLE IF NOT EXISTS Appointment (
    DateAndStartingTime TIME,
    patientid INTEGER(8) NOT NULL,
    uniqueIdentifierCode(2) TEXT NOT NULL,
    appointmentid INTEGER(8) PRIMARY KEY,
    uniqueNumber INTEGER(3) NOT NULL,
    clerkid INTEGER(8) NOT NULL,
    FOREIGN KEY (patientid) REFERENCES Patient(patientid),
    FOREIGN KEY (uniqueIdentifierCode) REFERENCES Surgeon(uniqueIdentifierCode),
    FOREIGN KEY (uniqueNumber) REFERENCES Room(uniqueNumber),
);

CREATE TRIGGER generate_invoice
BEFORE INSERT ON Invoice
FOR EACH ROW
BEGIN
    
    IF (SELECT clerkid FROM Appointment WHERE appointmentid = NEW.appointmentid) IS NULL THEN
       
        SELECT RAISE(ABORT,'Cannot generate invoice. Clerkid is null.') ;
    END IF;
END;

ALTER TABLE Appointment
ADD COLUMN uniquedate;

UPDATE Appointment 
SET uniquedate = DATE(DateAndStartingTime);

CONSTRAINT uniqueappointment UNIQUE(uniquedate, uniqueNumber, uniqueIdentifierCode)
);




CREATE TABLE IF NOT EXISTS Invoice (
    uniqueInvoiceNumber INTEGER(5) PRIMARY KEY,
    relevantDate TIME,
    clinicalComment TEXT(200),
    status TEXT(1),
    totalFee NUMERIC(4, 2),
    patientid INTEGER(8),
    description TEXT(20),
    uniqueIdentifierCode TEXT(2),
    customerid INTEGER(8),
    FOREIGN KEY (patientid) REFERENCES Patient(patientid),
    FOREIGN KEY (uniqueIdentifierCode) REFERENCES Surgeon(uniqueIdentifierCode),
    FOREIGN KEY (description) REFERENCES Service(description),
    FOREIGN KEY (customerid) REFERENCES Customer(clientNumber)
    
); 


SELECT 
    i.uniqueInvoiceNumber,
    i.relevantDate,
    i.patientid,
    i.description,
    i.uniqueIdentifierCode,
    i.customerid,
    SUM(s.currentServiceFee) AS currentFee,
    SUM(f.actualFee) AS actualFee,
    SUM(s.currentServiceFee) + SUM(f.actualFee) AS totalFee
FROM 
    Invoice i
JOIN 
    Service s ON i.uniqueIdentifierCode = s.uniqueIdentifierCode AND i.description = s.description
JOIN 
    Fees f ON i.uniqueIdentifierCode = f.uniqueIdentifierCode AND i.description = s.description
GROUP BY 
    i.uniqueInvoiceNumber, i.relevantDate, i.patientid, i.description, i.uniqueIdentifierCode, i.customerid;

-----------------------------------------EXAMPLES----------------------------------------------------------------
Surgeon Table:

INSERT INTO Surgeon (uniqueIdentifierCode, familyName, personalName, title, contactPhoneNumber, qualifications) 
VALUES 
('AB', 'Smith', 'John', 'Dr.', '123-456-7890', 'MD'),
('CD', 'Johnson', 'Alice', 'Dr.', '987-654-3210', 'MD');

Client Table:

INSERT INTO Client (clientNumber, familyName, personalName, title, streetAddress, postcode) 
VALUES 
(1, 'Doe', 'Jane', 'Ms.', '123 Main St', '1234'),
(2, 'Brown', 'Bob', 'Mr.', '456 Elm St', '5678');

Customer Table:

INSERT INTO Customer (customerid, clientNumber, contactPhoneNumebers) 
VALUES 
(101, 1, '111-222-3333'),
(102, 2, '444-555-6666');

 Patient Table:

INSERT INTO Patient (patientid, birthdate, customerid, medicareNumber) 
VALUES 
(1001, '1990-01-01', 101, '123456789A'),
(1002, '1985-05-15', 102, '987654321B');

Service Table:

INSERT INTO Service (prescribedCode, description, currentServiceFee, uniqueIdentifierCode) 
VALUES 
('001', 'Consultation', 50.00, 'AB'),
('002', 'X-Ray', 100.00, 'AB'),
('003', 'Blood Test', 75.00, 'CD');

Fees Table:

INSERT INTO Fees (actualFee, uniqueIdentifierCode) 
VALUES 
(200.00, 'AB'),
(150.00, 'CD');

 Invoice Table:

INSERT INTO Invoice (uniqueInvoiceNumber, relevantDate, clinicalComment, status, totalFee, patientid, description, uniqueIdentifierCode, customerid) 
VALUES 
(1001, '2024-05-13 14:30:00', 'Follow-up appointment', 'Paid', 50.00, 1001, 'Consultation', 'AB', 101),
(1002, '2024-05-14 10:30:00', 'X-ray examination', 'Unpaid', 100.00, 1002, 'X-Ray', 'AB', 102);

prefroom Table:

INSERT INTO prefroom (preferredRoom, uniqueIdentifierCode) 
VALUES 
('101A', 'AB'),
('102B', 'CD');

Room Table:

INSERT INTO Room (uniqueNumber, uniqueIdentifierCode) 
VALUES 
(101, 'AB'),
(102, 'CD');
